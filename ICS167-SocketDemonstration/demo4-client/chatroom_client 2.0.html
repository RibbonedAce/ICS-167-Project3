<!DOCTYPE html>
<html>
<title>
    Multiplayer Pong
</title>
<head>
    <link rel="stylesheet" type="text/css" href="pongClient.css">
</head>
<center><body>  
    
    <div class="serverContainer">
        <div>IP: <input type="text" name="ip" value="127.0.0.1" id="ipEntry"></div>
        <div>Port: <input type="text" name="port" value="8082" id="portEntry"></div>
        <div>Name: <input type="text" name="name" value="Bob" id="nameEntry"></div>
        <div><button type="button" onclick="connect();", id="connectButton">Connect</button></div>
		<div><button type="button" onclick="disconnect();", id="disconnectButton">Disonnect</button></div>
		<div><button type="button" onclick="ready();", id="readyButton">Ready</button></div>
    </div>
    
    <div class="playerContainer">
        <div><label type="text" name="p1Score" id="score1"> </label></div>
        <div><label type="text" name="p2Score" id="score2"> </label></div>
        <div><label type="text" name="p3Score" id="score3"> </label></div>
        <div><label type="text" name="p4Score" id="score4"> </label></div>
    </div>
    
    <div class="playerContainer">
        <div class="square" name="p1Color" id="color1"></div>
        <div class="square" name="p2Color" id="color2"></div>
        <div class="square" name="p3Color" id="color3"></div>
        <div class="square" name="p4Color" id="color4"></div>
    </div>
    
    <div style="padding-top: 5px; padding-bottom: 5px;">
        <canvas id="gameCanvas" width="550" height="550" style="border:5px solid black;"></canvas>
    </div> 
    
    <div style="padding-top: 5px; padding-bottom: 5px;">
        <label type="text" name="updates" id="updateBar">Welcome to Multiplayer Pong</label>
    </div>
    
</body></center> 
    
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
	<script src="fancywebsocket.js"></script>
	<script>
		
        var myGamePiece;
        var gameBall;
		var isGamePlaying = false;
		
		var Server;
		var uName;
        var score = 0;
		var ID;
		var readyStatus = false;
		
		var xBall=275;
		var yBall=275;
		
		var xPaddle;
		var yPaddle;
		var paddleW;
		var paddleH;
        var paddleColor = "#ffffff";
		var opponents = [];
		
		var dx=5;
		var dy=5;
		
        function playerPos(id){
			var arr;
			if(id == 0)
			{
				arr = new Array(20,215,10,120);
			}
			else if(id == 1)
			{
				arr = new Array(215,20,120,10);
			}
			else if(id == 2)
			{
				arr = new Array(520,215,10,120);
			}
			else if(id == 3)
			{
				arr = new Array(215,520,120,10);
			}
			return arr;
		}
		function getOpByID(id)
		{
			for(i = 0; i < opponents.length ; i++)
			{
				if(opponents[i].IDs == id)
				{
					var result = opponents[i];
					return result;
				}
			}
		}
		function structPlayer(name,id,color,oScore)
		{
			console.log(id);
			var x = playerPos(parseInt(id));
			var p = new paddle(x[2],x[3],color,x[0],x[1]);
			var c = {
				names: name,
				IDs: id,
				Colors: color,
				Paddle: p,
				Score : oScore
			}
			return c;
		}
		
        var myGameArea = {
            canvas : document.getElementById("gameCanvas") ,
            start : function() {
                this.context = this.canvas.getContext("2d");
                this.interval = setInterval(updateGameArea, 20);
                window.addEventListener('keydown', function (e) {
                    myGameArea.key = e.keyCode;
                })
                window.addEventListener('keyup', function (e) {
                    myGameArea.key = false;
                })
            }, 
            clear : function(){
                this.context.clearRect(0, 0, this.canvas.width, this.canvas.height);
            }
        }
        
		function updateOpponentCoordinates(text)
		{
				var res = text.split(";");
				if(ID == 0)
				{
					//opponent ID: 1
					opponents[0].name = res[2].split(",")[1];
					opponents[0].Paddle.setX(parseFloat(res[2].split(",")[2]));
					opponents[0].Score = res[2].split(",")[3];
					//opponent ID: 2
					opponents[1].name = res[3].split(",")[1];
					opponents[1].Paddle.setY(parseFloat(res[3].split(",")[2]));
					opponents[1].Score = res[3].split(",")[3];
					//opponent ID: 3
					opponents[2].name = res[4].split(",")[1];
					opponents[2].Paddle.setX(parseFloat(res[4].split(",")[2]));
					opponents[2].Score = res[4].split(",")[3];
				}
				else if(ID == 1)
				{
					//opponent ID: 0
					opponents[0].name = res[1].split(",")[1];
					opponents[0].Paddle.setY(parseFloat(res[1].split(",")[2]));
					opponents[0].Score = res[1].split(",")[3];
					//opponent ID: 2
					opponents[1].name = res[3].split(",")[1];
					opponents[1].Paddle.setY(parseFloat(res[3].split(",")[2]));
					opponents[1].Score = res[3].split(",")[3];
					//opponent ID: 3
					opponents[2].name = res[4].split(",")[1];
					opponents[2].Paddle.setX(parseFloat(res[4].split(",")[2]));
					opponents[2].Score = res[4].split(",")[3];
				}
				else if(ID == 2)
				{
					//opponent ID: 0
					opponents[0].name = res[1].split(",")[1];
					opponents[0].Paddle.setY(parseFloat(res[1].split(",")[2]));
					opponents[0].Score = res[1].split(",")[3];
					//opponent ID: 1
					opponents[1].name = res[2].split(",")[1];
					opponents[1].Paddle.setX(parseFloat(res[2].split(",")[2]));
					opponents[1].Score = res[2].split(",")[3];
					//opponent ID: 3
					opponents[2].name = res[4].split(",")[1];
					opponents[2].Paddle.setX(parseFloat(res[4].split(",")[2]));
					opponents[2].Score = res[4].split(",")[3];
				}
				else
				{
					//opponent ID: 0
					opponents[0].name = res[1].split(",")[1];
					opponents[0].Paddle.setY(parseFloat(res[1].split(",")[2]));
					opponents[0].Score = res[1].split(",")[3];
					//opponent ID: 1
					opponents[1].name = res[2].split(",")[1];
					opponents[1].Paddle.setX(parseFloat(res[2].split(",")[2]));
					opponents[1].Score = res[2].split(",")[3];
					//opponent ID: 2
					opponents[2].name = res[3].split(",")[1];
					opponents[2].Paddle.setY(parseFloat(res[3].split(",")[2]));
					opponents[2].Score = res[3].split(",")[3];
				}
		}
		function initPlayers(strng)
		{
			var temp = strng.split(";");
			for(i = opponents.length; i < temp.length; ++i)
			{
				var index = temp[i].split(",");
				if(ID != parseInt(index[0]))
				{
					var newC = "#" + index[2];
					var o = structPlayer(index[1],index[0],newC,0);
					opponents.push(o);
				}
			}
		}
		function ProcessPayLoad(text)
		{
			var Pos;
			var index;
			if(text.substring(0,4) == "Game")
			{
				var temp = text.split(":");
				var pLoad = temp[1].split(":");
				console.log(pLoad);
				var res = pLoad.split(";");
				Pos = res[0].split(",");
				
				//Ball Coordinates update.
				xBall = parseInt(Pos[0]);
				yBall = parseInt(Pos[1]);
				
				//Player score update.
				score = res[ID + 1].split(",")[3];
				
				//Opponent update.
				updateOpponentCoordinates(pLoad);

			}
			if(text.substring(0,4) == "init")
			{	
				Pos = text.split(":");
				initPlayers(Pos[1]);
			}
		}
        
		function send( text ) {
			Server.send( 'message', text );
		}
		function getColor()
		{
			while ( paddleColor == "#ffffff")
			{
				paddleColor = '#'+Math.floor(Math.random()*16777215).toString(16).toUpperCase();
			}
		}
        function connect(){
            var ip = document.getElementById("ipEntry").value;
			var port = document.getElementById("portEntry").value;
			uName = document.getElementById("nameEntry").value;
			Server = new FancyWebSocket('ws://' + ip + ":" + port);
			getColor();
			
			$('#message').keypress(function(e) {
				if ( e.keyCode == 13 && this.value ) {
					send( this.value );
					$(this).val('');
				}
			});

			//Let the user know we're connected
			Server.bind('open', function() {
                document.getElementById("connectButton").disabled = true;
				uName = document.getElementById("nameEntry").value;
				send("Name:" + uName.toString() + ";" + paddleColor.substring(1,paddleColor.length));
			});

			//OH NOES! Disconnection occurred.
			Server.bind('close', function( data ) {
                document.getElementById("connectButton").disabled = false;
			});

			//Log any messages sent from server
			Server.bind('message', function( payload ) 
			{
				//log(payload);
				//slice payload to get info for gamestate
				document.getElementById("updateBar").innerHTML = payload;
				if(payload.substring(0,2) == "ID")
				{
					myGameArea.start();
					ID = parseInt(payload.substring(3,payload.length));
					var PlayerPos = playerPos(ID);
					xPaddle = PlayerPos[0];
					yPaddle = PlayerPos[1];
					paddleW = PlayerPos[2];
					paddleH = PlayerPos[3];
					myGamePiece = new paddle(paddleW,paddleH,paddleColor,xPaddle,yPaddle);
				}
				else if(payload == "Start")
				{
					//myGameArea.start();
					isGamePlaying = true;
				}
				else
				{
					ProcessPayLoad(payload);
				}
			});
			
			Server.connect();
			
            gameBall = new ball();
        }
        
        function disconnect()
		{
			document.getElementById("updateBar").innerHTML = "Disonnect";
			Server.disconnect();
			readyStatus = false;
		}
        
        function ready()
		{
			if(!isGamePlaying)
			{
				if(!readyStatus)
				{
					send("Ready:1");
					readyStatus = true;
					document.getElementById("readyButton").innerHTML = "Cancel";
				}
				else
				{
					send("Ready:0");
					readyStatus = false;
					document.getElementById("readyButton").innerHTML = "Ready";
				}
			}
		}
        
        function paddle(width, height, color, x, y) {
			this.gamearea = myGameArea;
            this.width = parseInt(width);
            this.height = parseInt(height);
            this.speedX = 0;
            this.speedY = 0; 
            this.x = parseFloat(x);
            this.y = parseFloat(y);    
            this.update = function() {
                ctx = this.gamearea.context;
				ctx.fillStyle = color;
				ctx.fillRect(this.x, this.y, this.width, this.height);
            }
            this.newPos = function() {
				if(isGamePlaying){
					this.x += this.speedX;
					this.y += this.speedY; 
					if(ID == 0 || ID == 2)
						send("Position:"+this.y.toString());
					else 
						send("Position:"+this.x.toString());
				}
            }
			this.newOppPos = function(opponent)
			{
				this.x = opponent.Paddle.x;
				this.y = opponent.Paddle.y;
				ctx = myGameArea.context;
                ctx.fillStyle = opponent.Colors;
				ctx.fillRect(this.x,this.y,this.width,this.height);
			}
			this.setX = function(XPOS)
			{
				this.x = XPOS;
			}
			this.setY = function(YPOS)
			{
				this.y = YPOS;
			}
        }
        
        function ball() {
            this.gamearea = myGameArea;  
            this.x = 275
            this.y = 275
            this.update = function() {
                ctx = myGameArea.context;
                ctx.beginPath();
                ctx.fillStyle="#ff0000";
                ctx.arc(this.x,this.y,10,0,Math.PI*2,true);
                ctx.closePath();
                ctx.fill();
                ctx.stroke();
            }
            this.newPos = function(x, y) {
                this.x = x;
                this.y = y; 
            }
        }
        function updateOppPos()
		{
			for(i = 0 ; i < opponents.length;i++)
			{
				opponents[i].Paddle.newOppPos(opponents[i]);
				if(opponents[i].IDs == 0)
				{
					document.getElementById("score1").innerHTML = opponents[i].names + ": " + opponents[i].Score;
					document.getElementById("color1").style.backgroundColor = opponents[i].Colors;
				}
				else if(opponents[i].IDs == 1)
				{
					document.getElementById("score2").innerHTML = opponents[i].names +": " + opponents[i].Score;
					document.getElementById("color2").style.backgroundColor = opponents[i].Colors;
				}
				else if(opponents[i].IDs == 2)
				{
					document.getElementById("score3").innerHTML = opponents[i].names +": " + opponents[i].Score;
					document.getElementById("color3").style.backgroundColor = opponents[i].Colors;
				}
				else
				{
					document.getElementById("score4").innerHTML = opponents[i].names +": " +opponents[i].Score;
					document.getElementById("color4").style.backgroundColor = opponents[i].Colors;
				}
			}
		}
        function updateGameArea() {
            myGameArea.clear();
            myGamePiece.speedX = 0;
            myGamePiece.speedY = 0;
			if(ID == 1 || ID == 3)
			{
				if (myGameArea.key && myGameArea.key == 37 && myGamePiece.x > 20) {myGamePiece.speedX = -2; }
				if (myGameArea.key && myGameArea.key == 39 && myGamePiece.x < 410) {myGamePiece.speedX = 2; }
			}
			if(ID == 0 || ID == 2)
			{
				if (myGameArea.key && myGameArea.key == 38 && myGamePiece.y > 20) {myGamePiece.speedY = -2; }
				if (myGameArea.key && myGameArea.key == 40 && myGamePiece.y < 410) {myGamePiece.speedY = 2; }
			}
            gameBall.newPos(xBall, yBall);
            gameBall.update();
            myGamePiece.newPos();    
            myGamePiece.update();
			updateOppPos();
			if(ID == 0){
				document.getElementById("score1").innerHTML = uName + ": " + score;
				document.getElementById("color1").style.backgroundColor = paddleColor;
			}
			else if(ID == 1){
				document.getElementById("score2").innerHTML = uName + ": " + score;
				document.getElementById("color2").style.backgroundColor = paddleColor;
			}
			else if(ID == 2){
				document.getElementById("score3").innerHTML = uName + ": " + score;
				document.getElementById("color3").style.backgroundColor = paddleColor;
			}
			else {
				document.getElementById("score4").innerHTML = uName + ": " + score;
				document.getElementById("color4").style.backgroundColor = paddleColor;
			}
        }
	</script>
</html>
