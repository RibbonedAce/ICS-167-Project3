<!DOCTYPE html>
<html>
<title>
    Multiplayer Pong
</title>
<head>
    <link rel="stylesheet" type="text/css" href="pongClient.css">
</head>
<center><body>  
    
    <div class="serverContainer">
        <div>IP: <input type="text" name="ip" value="127.0.0.1" id="ipEntry"></div>
        <div>Port: <input type="text" name="port" value="8082" id="portEntry"></div>
        <div>Name: <input type="text" name="name" value="Bob" id="nameEntry"></div>
        <div><button type="button" onclick="connect();", id="connectButton">Connect</button></div>
		<div><button type="button" onclick="disconnect();", id="disconnectButton">Disconnect</button></div>
		<div><button type="button" onclick="ready();" id='readyButton'>Ready</button></div>
    </div>
    
    <div class="playerContainer">
        <div><label type="text" name="p1Score" id="score1"> </label></div>
        <div><label type="text" name="p2Score" id="score2"> </label></div>
        <div><label type="text" name="p3Score" id="score3"> </label></div>
        <div><label type="text" name="p4Score" id="score4"> </label></div>
    </div>
    
    <div class="playerContainer">
        <div class="square" name="p1Color" id="color1"></div>
        <div class="square" name="p2Color" id="color2"></div>
        <div class="square" name="p3Color" id="color3"></div>
        <div class="square" name="p4Color" id="color4"></div>
    </div>
    
    <div style="padding-top: 5px; padding-bottom: 5px;">
        <canvas id="gameCanvas" width="550" height="550" style="border:5px solid black;"></canvas>
    </div> 
  
    <div style="padding-top: 5px; padding-bottom: 5px;">
        <label type="text" name="updates" id="updateBar">Welcome to Multiplayer Pong</label>
    </div>
    
</body></center> 
    
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
	<script src="fancywebsocket.js"></script>
	<script>
		
        var Player1Piece;
		var Player2Piece;
		var Player3Piece;
		var Player4Piece;
        var gameBall;
        
		var Server;
		var ID;
        var pLstring;
		
		var xBall=275;
		var yBall=275;
		
		var x1Paddle = 20;
		var y1Paddle = 20;
		var paddleW1 = 10;
		var paddleH1 = 120;
        var paddleColor = "#ffffff";
		var score1 = 0;
		var uName1 = "";
		
		var x2Paddle = 215;
		var y2Paddle = 20;
		var paddleW2 = 120;
		var paddleH2= 10;
        var paddleColor2 = "#ffffff";
		var score2 = 0;
		var uName2 = "";
		
		var x3Paddle = 520;
		var y3Paddle = 20;
		var paddleW3 = 10;
		var paddleH3 = 120;
        var paddleColor3 = "#ffffff";
		var score3 = 0;
		var uName3 = "";
		
		var x4Paddle = 215;
		var y4Paddle = 520;
		var paddleW4 = 120;
		var paddleH4 = 10;
        var paddleColor4 = "#ffffff";
		var score4 = 0;
		var uName4 = "";
		
		var dx=5;
		var dy=5;
        
        var myGameArea = {
            canvas : document.getElementById("gameCanvas") ,
            start : function() {
                //this.canvas.width = 480;
                //this.canvas.height = 270;
                this.context = this.canvas.getContext("2d");
                //document.body.insertBefore(this.canvas, document.body.childNodes[0]);
                this.interval = setInterval(updateGameArea, 20);
                window.addEventListener('keydown', function (e) {
                    myGameArea.key = e.keyCode;
                })
                window.addEventListener('keyup', function (e) {
                    myGameArea.key = false;
                })
            }, 
            clear : function(){
                this.context.clearRect(0, 0, this.canvas.width, this.canvas.height);
            }
        }
        
		
		function ProcessPayLoad(text)
		{
			var Pos;
			var pLoad = text.split(":").pop();
			
			var index;
			var res = pLoad.split(";");
			Pos = res[0].split(",");
            xBall = parseInt(Pos[0]);
            yBall = parseInt(Pos[1]);
            gameBall.newPos(xBall, yBall);
            gameBall.update();
            score1 = res[1].split(",")[3];
		}
        
        
		function send( text ) {
			Server.send( 'message', text );
		}

        function connect(){
            
			Server = new FancyWebSocket('ws://' + document.getElementById("ipEntry").value + ":" + document.getElementById("portEntry").value);
			
			$('#message').keypress(function(e) {
				if ( e.keyCode == 13 && this.value ) {
					send( this.value );
					$(this).val('');
				}
			});
		
        
			//Let the user know we're connected
			Server.bind('open', function() {
                document.getElementById("connectButton").disabled = true;
				uName1 = document.getElementById("nameEntry").value;
				send("Name:" + uName1.toString());
			});

			//OH NOES! Disconnection occurred.
			Server.bind('close', function( data ) {
                document.getElementById("connectButton").disabled = false;
			});

			//Log any messages sent from server
			Server.bind('message', function( payload ) 
			{
				//log(payload);
				//slice payload to get info for gamestate
				pLstring = payload;
				if(payload.substring(0,2) =="ID")
				{
					ID = payload.substring(3,payload.length);		
				}
				if(payload.substring(0,4) == "Game")
				{
					ProcessPayLoad(payload);
				}
			});

			Server.connect();
            myGameArea.start();
			
            paddleColor = '#'+Math.floor(Math.random()*16777215).toString(16).toUpperCase();
			paddleColor2 = '#'+Math.floor(Math.random()*16777215).toString(16).toUpperCase();
			paddleColor3 = '#'+Math.floor(Math.random()*16777215).toString(16).toUpperCase();
			paddleColor4 = '#'+Math.floor(Math.random()*16777215).toString(16).toUpperCase();
            while( paddleColor == "#ffffff"){
			    paddleColor = '#'+Math.floor(Math.random()*16777215).toString(16).toUpperCase();
			  }
			while( paddleColor2 == "#ffffff" || paddleColor2 == paddleColor){
			    paddleColor2 = '#'+Math.floor(Math.random()*16777215).toString(16).toUpperCase();
			  }
			while( paddleColor3 == "#ffffff" || paddleColor3 == paddleColor || paddleColor3 == paddleColor2){
			    paddleColor3 = '#'+Math.floor(Math.random()*16777215).toString(16).toUpperCase();
			  }
			while( paddleColor4 == "#ffffff" || paddleColor4 == paddleColor || paddleColor4 == paddleColor2 || paddleColor4 == paddleColor3){
			    paddleColor4 = '#'+Math.floor(Math.random()*16777215).toString(16).toUpperCase();
			  }
			//game ball
			gameBall = new ball();
			
			//players' paddles
            Player1Piece = new paddle(paddleW1, paddleH1, paddleColor, x1Paddle, y1Paddle);
			Player2Piece = new paddle(paddleW2, paddleH2, paddleColor2, x2Paddle, y2Paddle);
			Player3Piece = new paddle(paddleW3, paddleH3, paddleColor3, x3Paddle, y3Paddle);
			Player4Piece = new paddle(paddleW4, paddleH4, paddleColor4, x4Paddle, y4Paddle);

			//player1 score
            document.getElementById("score1").innerHTML = uName1 + ": " + score1;
			document.getElementById("score2").innerHTML = uName2 + ": " + score2;
			document.getElementById("score3").innerHTML = uName3 + ": " + score3;
			document.getElementById("score4").innerHTML = uName4 + ": " + score4;
			//player2 score
			document.getElementById("color1").style.backgroundColor = paddleColor;
            document.getElementById("color2").style.backgroundColor = paddleColor2;
			document.getElementById("color3").style.backgroundColor = paddleColor3;
            document.getElementById("color4").style.backgroundColor = paddleColor4;
        }
        
        function disconnect()
		{
			Server.disconnect();
		}
        
        
        
        function paddle(width, height, color, x, y) {
            this.gamearea = myGameArea;
            this.width = width;
            this.height = height;
            this.speedX = 0;
            this.speedY = 0; 
            this.x = x;
            this.y = y;    
            this.update = function() {
                ctx = myGameArea.context;
                ctx.fillStyle = color;
                ctx.fillRect(this.x, this.y, this.width, this.height);
            }
            this.newPos = function() {
                this.x += this.speedX;
                this.y += this.speedY;
				if(ID == 1 || ID == 3)
					send("Position:"+this.y.toString());
				else
					send("Position:"+this.x.toString());
            }
        }
        
        function ball() {
            this.gamearea = myGameArea;  
            this.x = 275
            this.y = 275
            this.update = function() {
                ctx = myGameArea.context;
                ctx.beginPath();
                ctx.fillStyle="#ff0000";
                ctx.arc(this.x,this.y,10,0,Math.PI*2,true);
                ctx.closePath();
                ctx.fill();
                ctx.stroke();
            }
            this.newPos = function(x, y) {
                this.x = x;
                this.y = y; 
                console.log(this.x + ", " + this.y);
            }
        }
        
        function updateGameArea() {
            myGameArea.clear();
			
			gameBall.newPos(xBall, yBall);
            gameBall.update();
			
            Player1Piece.speedX = 0;
            Player1Piece.speedY = 0;
			
			Player2Piece.speedX = 0;
            Player2Piece.speedY = 0;
			
			Player3Piece.speedX = 0;
            Player3Piece.speedY = 0;
			
			Player4Piece.speedX = 0;
            PlayerPiece.speedY = 0;

			if(ID == "0")
			{
				if (myGameArea.key && myGameArea.key == 38 && Player1Piece.y > 20) {Player1Piece.speedY = -2; }
				if (myGameArea.key && myGameArea.key == 40 && Player1Piece.y < 410) {Player1Piece.speedY = 2; }
				
				Player1Piece.newPos();    
				Player1Piece.update();
			
				Player2Piece.newPos();    
				Player2Piece.update();
				
				Player3Piece.newPos();    
				Player3Piece.update();
				
				Player4Piece.newPos();    
				Player4Piece.update();
			}
			else if(ID == "1")
			{
				if (myGameArea.key && myGameArea.key == 38 && Player2Piece.x > 20) {Player2Piece.speedX = -2; }
				if (myGameArea.key && myGameArea.key == 40 && Player2Piece.x < 410) {Player2Piece.speedX = 2; }
				
				Player1Piece.newPos();    
				Player1Piece.update();
			
				Player2Piece.newPos();    
				Player2Piece.update();
				
				Player3Piece.newPos();    
				Player3Piece.update();
				
				Player4Piece.newPos();    
				Player4Piece.update();
			}
			else if(ID == "2")
			{
				if (myGameArea.key && myGameArea.key == 38 && Player3Piece.y > 20) {Player3Piece.speedY = -2; }
				if (myGameArea.key && myGameArea.key == 40 && Player3Piece.y < 410) {Player3Piece.speedY = 2; }
				
				Player1Piece.newPos();    
				Player1Piece.update();
			
				Player2Piece.newPos();    
				Player2Piece.update();
				
				Player3Piece.newPos();    
				Player3Piece.update();
				
				Player4Piece.newPos();    
				Player4Piece.update();
			}
			else
			{
				if (myGameArea.key && myGameArea.key == 38 && Player4Piece.x > 20) {Player4Piece.speedX = -2; }
				if (myGameArea.key && myGameArea.key == 40 && Player4Piece.x < 410) {Player4Piece.speedX = 2; }
				
				Player1Piece.newPos();    
				Player1Piece.update();
			
				Player2Piece.newPos();    
				Player2Piece.update();
				
				Player3Piece.newPos();    
				Player3Piece.update();
				
				Player4Piece.newPos();    
				Player4Piece.update();
			}
					
            document.getElementById("score1").innerHTML = uName1 + ": " + score1;
			document.getElementById("score2").innerHTML = uName2 + ": " + score2;
			document.getElementById("score3").innerHTML = uName1 + ": " + score3;
			document.getElementById("score4").innerHTML = uName2 + ": " + score4;
			
			document.getElementById("updateBar").innerHTML = pLstring;
        }
	</script>
</html>
